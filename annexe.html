<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <script src="https://d3js.org/d3.v6.min.js"></script>
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/3.4.1/css/bootstrap.min.css" integrity="sha384-HSMxcRTRxnN+Bdg0JdbxYKrThecOKuH5zCYotlSAcp1+c8xmyTe9GYg1l9a69psu" crossorigin="anonymous">
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/3.4.1/css/bootstrap-theme.min.css" integrity="sha384-6pzBo3FDv/PJ8r2KRkGHifhEocL+1X2rVCTTkUfGk7/0pbek5mMa1upzvWbrUbOZ" crossorigin="anonymous">
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/3.4.1/js/bootstrap.min.js" integrity="sha384-aJ21OjlMXNL5UyIl/XNwTMqvzeRMZH2w8c5cRVpzpU8Y5bApTppSuUkhZXN0VxHd" crossorigin="anonymous"></script>
      <link href="https://ev07.github.io/e-waste.dataviz/src/styles.css" rel="stylesheet" media="all" type="text/css">
      

      <body>

        <div id="my_dataviz">

            <div class="wrapper">
                <!--Déclaration des radiobutton-->
            
                <div class="Selectioncontainer">
                    <p>Choisissez le type de déchet :</p>
                    <div>
                        <input type="radio" id="TOTAL" name="ProductType" value="TOTAL" checked />
                        <label for="TOTAL">Total</label>
                    </div>
                    <div>
                        <input type="radio" id="EE_LHA" name="ProductType" value="EE_LHA" />
                        <label for="EE_LHA">Gros appareils ménagers</label>
                    </div>
                    <div>
                        <input type="radio" id="EE_SHA" name="ProductType" value="EE_SHA" />
                        <label for="EE_SHA">Petits appareils ménagers</label>
                    </div>
                    <div>
                        <input type="radio" id="EE_ITT" name="ProductType" value="EE_ITT" />
                        <label for="EE_ITT">
                            Equipements informatiques et de télécommunications
                        </label>
                    </div>
                    <div>
                        <input
                            type="radio"
                            id="EE_CPV_CON"
                            name="ProductType"
                            value="EE_CPV_CON"
                        />
                        <label for="EE_CPV_CON"> Matériel grand public </label>
                    </div>
                    <div>
                        <input type="radio" id="EE_TLS" name="ProductType" value="EE_TLS" />
                        <label for="EE_TLS"> Jouets, équipements de loisirs et de sport</label>
                    </div>
            
                    <p>Choisissez l'étape du traitement:</p>
                    <div>
                        <input type="radio" id="MKT" name="ProductStep" value="MKT" checked />
                        <label for="MKT"> Quantité mise sur le marché</label>
                    </div>
                    <div>
                        <input type="radio" id="COL" name="ProductStep" value="COL" />
                        <label for="COL"> Quantité collectée comme déchêt</label>
                    </div>
                    <div>
                        <input type="radio" id="RCY_REU" name="ProductStep" value="RCY_REU" />
                        <label for="RCY_REU">
                            Quantité recyclée ou partiellement réutilisée</label
                        >
                    </div>
                    <div>
                        <input type="radio" id="RCV" name="ProductStep" value="RCV" />
                        <label for="RCV"> Quantité valorisée en énergie</label>
                    </div>
                    <div>
                        <input type="radio" id="REU" name="ProductStep" value="REU" />
                        <label for="REU"> Quantité réparée et réutilisée</label>
                    </div>
                </div>
            

                <div id="chart"></div>
               
            </div> 






            
        </div>


        <script>
        /* Initialisation des variables de l'histogramme */
        const margin = {top: 20, right: 20, bottom: 90, left: 120},
        width = 800 - margin.left - margin.right,
        height = 400 - margin.top - margin.bottom;
        
        
        
               
        d3.selectAll("input[name='ProductType']").on("change", function (event) {
            d3.select("#chart").select("svg").remove();
            MakeHist()
    //update variable de type
            
        });
        d3.selectAll("input[name='ProductStep']").on("change", function (event) {
    //update variable d'opération
            d3.select("#chart").select("svg").remove();
            MakeHist()                        
                        
            });
            

            function MakeHist(){
                d3.csv("data/annexe.csv").then(function (csvdata) {
                    /* Initialisation des variables pour les data */
                    var dict = {};
                    var labelYear = [];
                    var max = 0;
                    cpt_row = 0;
                    for( i = 2005 ; i < 2019; i ++) {
                        key = "y"+String(i);
                        labelYear.push(key);
                        dict[key] = parseFloat(0);

                    }
                    var waste = d3.select('input[name="ProductType"]:checked')
                            .property("value");
                    var wst_oper = d3.select('input[name="ProductStep"]:checked')
                            .property("value");
                    let  yearTonne = [];
                    console.log("waste type "+waste)
                    console.log("waste oper "+wst_oper)

                    // On recupere pour chaque type de dechet et d'operations la somme par année
                    for(i = 0 ; i < csvdata.length ;i ++){
                        if(csvdata[i].waste == waste && csvdata[i].wst_oper == wst_oper){
                            cpt_row += 1;
                            for(var j = 0 ; j < labelYear.length;j++){
                                dict[labelYear[j]] += (Number(csvdata[i][labelYear[j]])) 
                            
                            }   
                        }
                    }
                    console.log(cpt_row+" lignes trouvés")
                    
                    for (var key in dict) {         
                        if (dict[key] > max ){
                            max = dict[key];
                        }
                        yearTonne.push({year:key.substring(1), value: String(dict[key])})      
                    }
                
                    const svg = d3.select("#chart").append("svg")
                        .attr("id", "svg")
                        .attr("width", width + margin.left + margin.right)
                        .attr("height", height + margin.top + margin.bottom)
                        .append("g")
                        .attr("transform", "translate(" + margin.left + "," + margin.top + ")");
                            


                    var x = d3.scaleBand()
                        .range([ 0, width ])
                        .domain(yearTonne.map(function(d) { return d.year; }))
                        .padding(0.2);
                        svg.append("g")
                        .attr("transform", "translate(0," + height + ")")
                        .call(d3.axisBottom(x))
                        .selectAll("text")
                        .attr("transform", "translate(-10,0)rotate(-45)")
                        .style("text-anchor", "end");
                                    
                    // Add Y axis
                    var y = d3.scaleLinear()
                        .domain([0, max])
                        .range([ height, 0]);
                        svg.append("g")
                        .call(d3.axisLeft(y));

                    // Bars
                    
                    var bar = svg.selectAll("mybar")
                    .data(yearTonne)
                    .enter()
                    .append("rect")
                        .attr("x", function(d) { return x(d.year); })
                        .attr("y", function(d) { return y(d.value); })
                        .attr("width", x.bandwidth())
                        .attr("height", function(d) { return height - y(d.value); })
                        .attr("fill", "#FF5733")
                    
                }
            )}

        MakeHist();
        </script>


      </body>